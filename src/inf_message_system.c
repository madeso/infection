/***************************************************
*           inf_message_system.c                   *
*      written by Gustav 'sirGustav' Jansson       *
*         for his first 3d game 'Infection'        *
*             started: 2002-07-19                  *
*             ended:                               *
*              mail: sir_gustav@passagen.se        *
*    URL: http://www.geocities.com/sir_gustavs     *
****************************************************/







#include "inf_message_system.h"
#include "useful_macros.h"
#include "string.h"
#include "globalGenesis.h"
#include "sound_system.h"
#include "log.h"



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// typedefs - static variables
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//how many messages are allowed
#define NUMBER_OF_MESSAGES		5
#define Y_OFFSET				20
#define X_OFFSET				5
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////







///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// local variables
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
int i; //iterator in/with  for/while loops
typedef struct hud_messages_tag
{
	char messages[NUMBER_OF_MESSAGES][STRING_LENGTH];
	unsigned int wait;
} HudMessages;

HudMessages isystem;
HudMessages game;
soundsys_sound soundOnMessage;
unsigned char y_plus=0;
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////










///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//		init_messages
//			initialize the message system
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void init_messages()
{
	isystem.wait = 0;
	game.wait = 0;
	soundsys_loadWaw(".\\sfx\\message.wav", &soundOnMessage);

	for(i = 0; i< NUMBER_OF_MESSAGES; i++)
	{
		isystem.messages[i][0] = 0;
	}

	for(i = 0; i< NUMBER_OF_MESSAGES; i++)
	{
		game.messages[i][0] = 0;
	}
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////









///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//		system_message
//			pop a system message  - system message in on the bottom left of screen
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void system_message(char *sz)
{
	for(i = NUMBER_OF_MESSAGES-1; i > 0; i--)
	{
		strcpy(isystem.messages[i], isystem.messages[i-1] );
	}

	//insert
	strcpy(isystem.messages[0], sz);

	//wait for 3 secs before clearing the messages
	isystem.wait = 3;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////











///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//		game_message
//			push a game message - game message is on the top left of the screen
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void game_message(char *sz)
{
	for(i = NUMBER_OF_MESSAGES-1; i > 0; i--)
	{
		strcpy(game.messages[i], game.messages[i-1] );
	}

	//insert
	strcpy(game.messages[0], sz);
/*
	printLog("\n\nGame messages is:\n");
	for(i = 0; i< NUMBER_OF_MESSAGES; i++)
	{
		sprintf(str, "\tnmbr %d, is \"%s\".\n", i+1, isystem.messages[i]);
		printLog(str);
	}
	printLog("Ended\n\n");
*/
	//wait for 3 secs before clearing the messages
	game.wait = 3;
	// play message sound
	soundsys_play_sound(&soundOnMessage, GE_FALSE);
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////









///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//		render_messages
//			render the messages
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
geBoolean render_messages()
{
	//system messages
	for( i= 0; i < NUMBER_OF_MESSAGES; i++)
	{
		if( isystem.messages[i][0] != 0 )
		{
			//if( geEngine_Printf(Engine, X_OFFSET , Height - Y_OFFSET*( NUMBER_OF_MESSAGES -i+1), messages[i]) == GE_FALSE )
			if( geEngine_Printf(Engine, X_OFFSET , Height -Y_OFFSET*(i+1) , isystem.messages[i]) == GE_FALSE )
			{
				printLog("Message fail system message\n");
				return GE_FALSE;
			}
		}
		else
		{
			break;
		}
	}

	//game message
	for( i= 0; i < NUMBER_OF_MESSAGES; i++)
	{
		if( game.messages[i][0] != 0 )
		{
			//if( geEngine_Printf(Engine, X_OFFSET , Height - Y_OFFSET*( NUMBER_OF_MESSAGES -i+1), messages[i]) == GE_FALSE )
			if( geEngine_Printf(Engine, X_OFFSET , Y_OFFSET*i + y_plus , game.messages[i]) == GE_FALSE )
			{
				printLog("Message fail game message\n");
				return GE_FALSE;
			}
		}
		else
		{
			break;
		}
	}

	return GE_TRUE;
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////














///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//		tick_messages
//			should be called evry second
//			pops messages if the mesage was waited some time without recieving any messages
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void tick_messages()
{
	//system messages
	if( isystem.wait > 0)
	{
		isystem.wait--;
	}
	else
	{
		for(i=NUMBER_OF_MESSAGES-1; i>= 0; i--)
		{
			if( isystem.messages[i][0] != 0)
			{
				isystem.messages[i][0] = 0;
				break;
			}
			else
			{
			}
		}
	}

	//game messages
	if( game.wait > 0)
	{
		game.wait--;
	}
	else
	{
		for(i=NUMBER_OF_MESSAGES-1; i>= 0; i--)
		{
			if( game.messages[i][0] != 0)
			{
				game.messages[i][0] = 0;
				break;
			}
			else
			{
			}
		}
	}
}
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////










///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
void set_y_shift(unsigned char y)
{
	y_plus = y;
}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////







///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// end of file
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

